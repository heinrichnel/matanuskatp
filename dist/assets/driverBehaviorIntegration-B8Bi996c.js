import{a as f}from"./index-uZ2PYNJn.js";const h={harsh_acceleration:"harsh_acceleration",seatbelt_violation_beep:"seatbelt_violation",seatbelt_violation:"seatbelt_violation",cell_phone_use_beep:"phone_usage",fatigue_alert_beep:"fatigue_alert",fatigue_alert:"fatigue_alert",harsh_braking:"harsh_braking",speedlimit:"speeding",lane_weaving:"lane_weaving",distracted_driver_beep:"distracted",distracted:"distracted",tailgating:"tailgating",passenger:"passenger",obstruction:"obstruction",wrong_pin_code:"wrong_pin_code",violent_left_turn:"violent_left_turn",violent_right_turn:"violent_right_turn",de_acceleration:"de_acceleration",acceleration:"acceleration",button_pressed:"button_pressed",tamper:"tamper",accident:"accident"},u={harsh_acceleration:{severity:"high",points:10},seatbelt_violation:{severity:"high",points:10},phone_usage:{severity:"medium",points:5},fatigue_alert:{severity:"high",points:10},harsh_braking:{severity:"high",points:10},speeding:{severity:"high",points:10},lane_weaving:{severity:"high",points:5},distracted:{severity:"high",points:10},passenger:{severity:"medium",points:3},tailgating:{severity:"high",points:7},obstruction:{severity:"medium",points:4},wrong_pin_code:{severity:"low",points:2},violent_left_turn:{severity:"medium",points:5},violent_right_turn:{severity:"medium",points:5},de_acceleration:{severity:"medium",points:3},acceleration:{severity:"medium",points:3},button_pressed:{severity:"low",points:1},tamper:{severity:"high",points:8},accident:{severity:"critical",points:50}},g=["jolt","acc_on","acc_off","smoking","unknown"],l=new Set,p=new Set;function _(e){if(!e)return new Date().toISOString().split("T")[0];try{if(e.includes("/")){const i=e.split("/");if(i.length===3){const[n,t,s]=i;return`${n}-${t.padStart(2,"0")}-${s.padStart(2,"0")}`}}const r=new Date(e);return isNaN(r.getTime())?new Date().toISOString().split("T")[0]:r.toISOString().split("T")[0]}catch(r){return console.error("Error parsing date:",r),new Date().toISOString().split("T")[0]}}function y(e){return[e.driverName||"",e.fleetNumber||"",e.eventDate||"",e.eventTime||"",e.eventType||"",e.description||""].join("|")}function m(e){if(e.rowId&&e.rowId>0){if(p.has(e.rowId))return console.log(`Event already processed by row ID: ${e.rowId}`),!0;p.add(e.rowId)}const r=y(e);if(l.has(r))return console.log(`Event already processed by fingerprint: ${r}`),!0;if(l.add(r),l.size>1e3){const i=l.values();for(let n=0;n<200;n++){const t=i.next().value;typeof t=="string"&&l.delete(t)}}if(p.size>1e3){const i=p.values();for(let n=0;n<200;n++){const t=i.next().value;typeof t=="number"&&p.delete(t)}}return!1}async function T(){try{const i=`https://script.google.com/macros/s/AKfycbw5_oPDd7wVIEOxf9rY6wKqUN1aNFuVqGrPl83Z2YKygZiHftyUxU-_sV4Wu_vY1h1vSg/exec?t=${Date.now()}`;console.log("Fetching driver events from:",i);const n=await fetch(i,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!n.ok)throw new Error(`Failed to fetch data: ${n.status} ${n.statusText}`);const t=await n.json();if(console.log("Received data:",t),!t||Array.isArray(t)&&t.length===0)return console.log("No new driver events to process"),null;const s=Array.isArray(t)?t:[t];let a=0;for(const o of s){const d=(o.eventType||"").toString().trim();if(!d||d.toUpperCase()==="UNKNOWN"){console.log("Skipping UNKNOWN event type");continue}const v=d.toLowerCase();if(g.includes(v)){console.log("Ignored event type:",v);continue}if(m(o)){console.log("Skipping already processed event:",o.eventType,o.driverName);continue}const c=w(o);c&&(await f({...c,id:""}),console.log("New driver event saved:",c),a++)}return console.log(`Processed ${a} new driver events out of ${s.length} total events`),a}catch(e){return console.error("Error fetching and saving driver events:",e),null}}function w(e){try{const r=(e.eventType||"").toString().trim();if(!r||r.toUpperCase()==="UNKNOWN")return null;const i=r.toLowerCase();if(g.includes(i))return null;const n=["speeding","harsh_braking","harsh_acceleration","idling","route_deviation","unauthorized_stop","fatigue_alert","phone_usage","seatbelt_violation","other"];let t="other";const s=i.replace(/\s+/g,"_").toLowerCase();for(const[v,c]of Object.entries(h))if(s.includes(v)&&n.includes(c)){t=c;break}let a=(e.severity||"medium").toLowerCase(),o=parseInt(e.points)||0;return u[t]&&(a=u[t].severity,o=u[t].points),{id:"",driverId:e.driverId||"",driverName:e.driverName||"Unknown",fleetNumber:e.fleetNumber||"Unknown",eventType:t,severity:a,eventDate:_(e.eventDate),eventTime:e.eventTime||"00:00",location:e.location||"",description:e.description||`${e.eventType} event detected for ${e.driverName}`,actionTaken:"",followUpRequired:!1,reportedBy:"Google Sheets Integration",reportedAt:e.reportedAt?new Date(e.reportedAt).toISOString():new Date().toISOString(),points:o}}catch(r){return console.error("Error processing event data:",r),null}}export{g as IGNORED_EVENTS,u as eventRules,h as eventTypeMap,T as fetchAndSaveDriverEvents,_ as parseDate};
