/**
 * Updated Google Apps Script for Driver Behavior Webhook
 * 
 * This script sends driver behavior events from a Google Sheet to Firebase.
 * It has been updated to ensure proper payload formatting for the enhanced webhook.
 * 
 * Instructions:
 * 1. Open Google Apps Script editor (script.google.com)
 * 2. Create a new project or open your existing driver behavior script
 * 3. Replace the entire content with this code
 * 4. Save and deploy as a web app
 */

// CONFIGURATION - Update these values
const FIREBASE_WEBHOOK_URL = 'https://us-central1-mat1-9e6b3.cloudfunctions.net/importDriverBehaviorWebhook';
const SHEET_NAME = 'driver_behavior';
const COLLECTION_NAME = 'driverBehavior';
const DEBUG_MODE = true;

/**
 * Posts driver behavior events from Google Sheet to Firebase
  * This function can be triggered on a schedule or manually
   */
   function postDriverBehaviorToFirebase() {
     Logger.log("üöÄ Starting driver behavior import process...");
       
         try {
             // Get the sheet
                 const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
                     if (!sheet) {
                           Logger.log("‚ùå ERROR: Sheet '" + SHEET_NAME + "' not found in the spreadsheet.");
                                 return;
                                     }
                                         
                                             // Get all data from the sheet
                                                 const data = sheet.getDataRange().getValues();
                                                     if (data.length <= 1) {
                                                           Logger.log("‚ÑπÔ∏è No data found or only headers present in the sheet.");
                                                                 return;
                                                                     }
                                                                         
                                                                             // Get the headers and validate
                                                                                 const headers = data[0];
                                                                                     const expectedHeaders = ["Fleet Number", "Driver Name", "Event Type", "Event Time", "Camera ID", "Video URL", "Severity", "Event Score", "Notes"];
                                                                                         const missingHeaders = expectedHeaders.filter(header => !headers.includes(header));
                                                                                             
                                                                                                 if (missingHeaders.length > 0) {
                                                                                                       Logger.log(`‚ö†Ô∏è Warning: Some expected headers are missing: ${missingHeaders.join(", ")}`);
                                                                                                             Logger.log(`Actual headers: ${headers.join(", ")}`);
                                                                                                                 }
                                                                                                                     
                                                                                                                         // Remove header row
                                                                                                                             data.shift();
                                                                                                                                 
                                                                                                                                     // Get previously sent events to avoid duplicates
                                                                                                                                         const props = PropertiesService.getScriptProperties();
                                                                                                                                             let sentRefs = props.getProperty('sentEventRefs');
                                                                                                                                                 sentRefs = sentRefs ? JSON.parse(sentRefs) : [];
                                                                                                                                                     
                                                                                                                                                         if (DEBUG_MODE) {
                                                                                                                                                               Logger.log(`‚ÑπÔ∏è Found ${data.length} rows of data. Previously sent: ${sentRefs.length} events.`);
                                                                                                                                                                   }

                                                                                                                                                                       // Process the data
                                                                                                                                                                           const eventsToPost = [];
                                                                                                                                                                               const errors = [];

                                                                                                                                                                                   data.forEach((row, index) => {
                                                                                                                                                                                         try {
                                                                                                                                                                                                 // Extract data from columns (adjust indices if column order differs)
                                                                                                                                                                                                         const [
                                                                                                                                                                                                                   fleetNumber,   // A
                                                                                                                                                                                                                             driverName,    // B
                                                                                                                                                                                                                                       eventType,     // C
                                                                                                                                                                                                                                                 eventTime,     // D
                                                                                                                                                                                                                                                           cameraId,      // E
                                                                                                                                                                                                                                                                     videoUrl,      // F
                                                                                                                                                                                                                                                                               severity,      // G
                                                                                                                                                                                                                                                                                         eventScore,    // H
                                                                                                                                                                                                                                                                                                   notes          // I
                                                                                                                                                                                                                                                                                                           ] = row;

                                                                                                                                                                                                                                                                                                                   // Skip empty rows or rows without key data
                                                                                                                                                                                                                                                                                                                           if (!fleetNumber || !eventType || !eventTime) {
                                                                                                                                                                                                                                                                                                                                     errors.push(`Row ${index + 2}: Missing required fields (fleetNumber, eventType, or eventTime)`);
                                                                                                                                                                                                                                                                                                                                               return; // Skip this row
                                                                                                                                                                                                                                                                                                                                                       }

                                                                                                                                                                                                                                                                                                                                                               // Generate a unique key for deduplication
                                                                                                                                                                                                                                                                                                                                                                       const uniqueKey = `${fleetNumber}_${eventType}_${eventTime instanceof Date ? eventTime.toISOString() : eventTime}`;
                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                       // Skip if already sent
                                                                                                                                                                                                                                                                                                                                                                                               if (sentRefs.includes(uniqueKey)) {
                                                                                                                                                                                                                                                                                                                                                                                                         if (DEBUG_MODE) Logger.log(`‚ÑπÔ∏è Skipping row ${index + 2} - Event ${uniqueKey} already sent.`);
                                                                                                                                                                                                                                                                                                                                                                                                                   return; // Skip this row
                                                                                                                                                                                                                                                                                                                                                                                                                           }

                                                                                                                                                                                                                                                                                                                                                                                                                                   // Build the event object with proper types - CRITICAL for webhook validation
                                                                                                                                                                                                                                                                                                                                                                                                                                           const event = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                     fleetNumber: String(fleetNumber), // Ensure it's a string
                                                                                                                                                                                                                                                                                                                                                                                                                                                               driverName: String(driverName || ""),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                         eventType: String(eventType),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   eventTime: eventTime instanceof Date ? eventTime.toISOString() : String(eventTime),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             cameraId: cameraId ? String(cameraId) : "",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       videoUrl: videoUrl ? String(videoUrl) : "",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 severity: severity ? String(severity) : "medium",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           eventScore: typeof eventScore === 'number' ? eventScore : parseFloat(eventScore) || 0,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     notes: notes ? String(notes) : "",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               createdAt: new Date().toISOString(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         importSource: "web_book",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   uniqueKey: uniqueKey // Add for deduplication
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           };

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   // Log the event data if in debug mode
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           if (DEBUG_MODE) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     Logger.log(`‚ÑπÔ∏è Event data for ${uniqueKey}:`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Logger.log(JSON.stringify(event, null, 2));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               // Add to the list of events to post
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       eventsToPost.push(event);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               sentRefs.push(uniqueKey);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     } catch (rowError) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             errors.push(`Error processing row ${index + 2}: ${rowError.message}`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           // Log any errors
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               if (errors.length > 0) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     Logger.log("‚ö†Ô∏è Errors encountered during data processing:");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           errors.forEach(error => Logger.log(` - ${error}`));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   // If no events to post, we're done
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       if (eventsToPost.length === 0) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             Logger.log("‚ÑπÔ∏è No new driver behavior events to post. Process complete.");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Logger.log(`üîÑ Sending ${eventsToPost.length} driver behavior events to Firebase...`);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               // CRITICAL: Prepare the payload with the EXACT structure expected by the webhook
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   // This is the key part that must match the enhanced webhook validation
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       const payload = JSON.stringify({ 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             events: eventsToPost,  // Array of events - MUST use "events" key
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   meta: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           source: "google_sheet",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   timestamp: new Date().toISOString(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           count: eventsToPost.length,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   targetCollection: COLLECTION_NAME
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     // Set up the request options
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         const options = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               method: 'POST',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     contentType: 'application/json',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           headers: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   'Content-Length': payload.length.toString(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           'X-Source': 'google-apps-script',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   'X-Batch-Size': eventsToPost.length.toString(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           'X-Target-Collection': COLLECTION_NAME
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       payload: payload,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             muteHttpExceptions: true // To catch HTTP errors in code
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         // Send the request
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             const response = UrlFetchApp.fetch(FIREBASE_WEBHOOK_URL, options);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 const responseCode = response.getResponseCode();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     const responseText = response.getContentText();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             Logger.log(`üì• Response Code: ${responseCode}`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     if (responseCode >= 200 && responseCode < 300) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           // Success - save the sent references
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 props.setProperty('sentEventRefs', JSON.stringify(sentRefs));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             // Parse response to get import summary
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           const responseData = JSON.parse(responseText);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Logger.log(`‚úÖ Import successful! Imported: ${responseData.imported}, Skipped: ${responseData.skipped}`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   if (DEBUG_MODE && responseData.processingDetails) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             Logger.log("üìã Processing details:");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       Logger.log(JSON.stringify(responseData.processingDetails, null, 2));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     } catch (e) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             Logger.log(`‚ö†Ô∏è Could not parse response JSON: ${e}`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     Logger.log(`Raw response: ${responseText}`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     Logger.log(`‚ùå Error sending driver behavior events to Firebase (HTTP ${responseCode}): ${responseText}`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Logger.log("üèÅ Driver behavior import process completed.");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   } catch (error) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       Logger.log(`‚ùå Critical error in postDriverBehaviorToFirebase: ${error.message}`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Logger.log(`Stack trace: ${error.stack}`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * Manual trigger function for testing - run this function directly to test
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               function testDriverBehaviorImport() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Logger.log("üß™ Running driver behavior import in TEST mode...");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   postDriverBehaviorToFirebase();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * Adds time-based trigger to run import automatically
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     * This is optional - you can run manually instead
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      function setupDailyTrigger() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // Delete any existing triggers
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const triggers = ScriptApp.getProjectTriggers();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            for (let i = 0; i < triggers.length; i++) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (triggers[i].getHandlerFunction() === 'postDriverBehaviorToFirebase') {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ScriptApp.deleteTrigger(triggers[i]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // Create a new daily trigger
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ScriptApp.newTrigger('postDriverBehaviorToFirebase')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      .timeBased()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          .everyDays(1)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              .atHour(6) // 6 AM
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  .create();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      Logger.log("‚úÖ Daily trigger set to run import at 6 AM");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * Creates a custom menu in the Google Sheet
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        function onOpen() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          SpreadsheetApp.getUi()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              .createMenu('Driver Behavior')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  .addItem('Import Events to Firebase', 'testDriverBehaviorImport')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      .addItem('Setup Daily Import Trigger', 'setupDailyTrigger')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          .addToUi();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }